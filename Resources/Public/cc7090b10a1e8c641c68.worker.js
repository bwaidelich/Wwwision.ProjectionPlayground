!function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/_Resources/Static/Packages/Wwwision.ProjectionPlayground/",n(n.s=0)}([function(t,e,n){"use strict";n.r(e);const r=Symbol("Comlink.proxy"),o=Symbol("Comlink.endpoint"),a=Symbol("Comlink.releaseProxy"),i=Symbol("Comlink.thrown"),s=t=>"object"==typeof t&&null!==t||"function"==typeof t,u=new Map([["proxy",{canHandle:t=>s(t)&&t[r],serialize(t){const{port1:e,port2:n}=new MessageChannel;return c(t,e),[n,[n]]},deserialize(t){return t.start(),function t(e,n=[],r=function(){}){let i=!1;const s=new Proxy(r,{get(r,o){if(l(i),o===a)return()=>g(e,{type:5,path:n.map(t=>t.toString())}).then(()=>{f(e),i=!0});if("then"===o){if(0===n.length)return{then:()=>s};const t=g(e,{type:0,path:n.map(t=>t.toString())}).then(y);return t.then.bind(t)}return t(e,[...n,o])},set(t,r,o){l(i);const[a,s]=m(o);return g(e,{type:1,path:[...n,r].map(t=>t.toString()),value:a},s).then(y)},apply(r,a,s){l(i);const u=n[n.length-1];if(u===o)return g(e,{type:4}).then(y);if("bind"===u)return t(e,n.slice(0,-1));const[c,f]=d(s);return g(e,{type:2,path:n.map(t=>t.toString()),argumentList:c},f).then(y)},construct(t,r){l(i);const[o,a]=d(r);return g(e,{type:3,path:n.map(t=>t.toString()),argumentList:o},a).then(y)}});return s}(t,[],e);var e}}],["throw",{canHandle:t=>s(t)&&i in t,serialize({value:t}){let e;return e=t instanceof Error?{isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:{isError:!1,value:t},[e,[]]},deserialize(t){if(t.isError)throw Object.assign(new Error(t.value.message),t.value);throw t.value}}]]);function c(t,e=self){e.addEventListener("message",(function n(o){if(!o||!o.data)return;const{id:a,type:s,path:u}=Object.assign({path:[]},o.data),l=(o.data.argumentList||[]).map(y);let d;try{const e=u.slice(0,-1).reduce((t,e)=>t[e],t),n=u.reduce((t,e)=>t[e],t);switch(s){case 0:d=n;break;case 1:e[u.slice(-1)[0]]=y(o.data.value),d=!0;break;case 2:d=n.apply(e,l);break;case 3:d=function(t){return Object.assign(t,{[r]:!0})}(new n(...l));break;case 4:{const{port1:e,port2:n}=new MessageChannel;c(t,n),d=function(t,e){return p.set(t,e),t}(e,[e])}break;case 5:d=void 0}}catch(t){d={value:t,[i]:0}}Promise.resolve(d).catch(t=>({value:t,[i]:0})).then(t=>{const[r,o]=m(t);e.postMessage(Object.assign(Object.assign({},r),{id:a}),o),5===s&&(e.removeEventListener("message",n),f(e))})})),e.start&&e.start()}function f(t){(function(t){return"MessagePort"===t.constructor.name})(t)&&t.close()}function l(t){if(t)throw new Error("Proxy has been released and is not useable")}function d(t){const e=t.map(m);return[e.map(t=>t[0]),(n=e.map(t=>t[1]),Array.prototype.concat.apply([],n))];var n}const p=new WeakMap;function m(t){for(const[e,n]of u)if(n.canHandle(t)){const[r,o]=n.serialize(t);return[{type:3,name:e,value:r},o]}return[{type:0,value:t},p.get(t)||[]]}function y(t){switch(t.type){case 3:return u.get(t.name).deserialize(t.value);case 0:return t.value}}function g(t,e,n){return new Promise(r=>{const o=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");t.addEventListener("message",(function e(n){n.data&&n.data.id&&n.data.id===o&&(t.removeEventListener("message",e),r(n.data))})),t.start&&t.start(),t.postMessage(Object.assign({id:o},e),n)})}var h,v={createEventProcessor:function(t,e){var n=!0,r={},o=[],a=[],i=[],s=[],u=[],c=function(){throw"GetStatePartition is not defined"},f={allStreams:!1,allEvents:!0,byStreams:!1,byCustomPartitions:!1,categories:[],streams:[],events:[],options:{definesStateTransform:!1,handlesDeletedNotifications:!1,producesResults:!1,definesFold:!1,resultStreamName:null,partitionResultStreamNamePattern:null,$includeLinks:!1,reorderEvents:!1,processingLag:0,biState:!1},version:4},l=function(){return{}},d=function(){return{}},p=null,m=null,y={set_debugging:function(){!0},initialize:function(){var t=l();return p=t,"OK"},initialize_shared:function(){var t=d();return m=t,"OK"},get_state_partition:function(t,e,n,r,o,a,i,s){return function(t,e,n,r,o,a,i,s){var u=c,f=new v(null,t,r,n,a,i,s,null,null);e&&h(f);var l,d=u(f);l=null==d||""===d?"":d.toString();return l}(t,e,n,r,0,a,i,s)},process_event:function(t,e,a,i,u,c,l,d,y){return function(t,e,a,i,u,c,l,d,y){var S,b,w=i,O=f.options.biState?[p,m]:p,N=new v(null,t,i,a,c,l,d,y);for(b=0;b<s.length;b++)S=s[b],O=g(S,O,N);S=r[w],e&&(n||void 0!==S||o.length>0)&&h(N);n&&(O=g(_,O,N));for(b=0;b<o.length;b++)S=o[b],O=g(S,O,N);void 0!==(S=r[w])&&(O=g(S,O,N));f.options.biState?(p=O[0],m=O[1]):p=O}(t,e,a,i,0,c,l,d,y),f.options.biState?[JSON.stringify(p),JSON.stringify(m)]:JSON.stringify(p)},process_deleted_notification:function(t,e){if(function(t,e){var n,r,o={partition:t,isSoftDeleted:e},i=f.options.biState?[p,m]:p;for(n=0;n<a.length;n++)r=a[n],i=g(r,i,o);if(f.options.biState)throw"Bi-State projections do not support delete notifications";p=i}(t,e),f.options.biState)throw"Bi-State projections do not support delete notifications";return JSON.stringify(p)},process_created_notification:function(t,e,n,r,o,a,s,u,c){return function(t,e,n,r,o,a,s,u,c){var l,d,y=f.options.biState?[p,m]:p,_=new v(null,t,r,n,a,s,u,c);e&&h(_);for(d=0;d<i.length;d++)l=i[d],y=g(l,y,_);f.options.biState?(p=y[0],m=y[1]):p=y}(t,e,n,r,0,a,s,u,c),JSON.stringify(p)},transform_state_to_result:function(){for(var t=p,e=0;e<u.length;e++){if(null===(t=(0,u[e])(t)))break}return null!==t?JSON.stringify(t):null},set_state:function(t){var e=JSON.parse(t);return p=e,"OK"},set_shared_state:function(t){var e=JSON.parse(t);return m=e,"OK"},debugging_get_state:function(){return JSON.stringify(p)},get_sources:function(){return JSON.stringify(f)}};function g(t,e,n){var r=t(e,n);return void 0===r&&(r=e),r}function h(e){var n=e.bodyRaw;try{""==n?e.body={}:"object"==typeof n?(e.body=n,e.isJson=!0):(e.body=JSON.parse(n),e.isJson=!0),e.data=e.body}catch(n){t("JSON Parsing error: "+n),e.jsonError=n,e.body=void 0,e.data=void 0}}function v(t,e,n,r,o,a,i,s){this.isJson=!1,this.data=t,this.body=t,this.bodyRaw=e,this.eventType=n,this.streamId=r,this.sequenceNumber=o,this.metadataRaw=a,this.linkMetadataRaw=i,this.partition=s,this.metadata_=null}function _(t,e){return e.isJson?e.body:{$e:e.bodyRaw}}return Object.defineProperty(v.prototype,"metadata",{get:function(){return!this.metadata_&&this.metadataRaw&&(this.metadata_=JSON.parse(this.metadataRaw)),this.metadata_}}),Object.defineProperty(v.prototype,"linkMetadata",{get:function(){return this.linkMetadata_||(this.linkMetadataRaw?this.linkMetadata_=JSON.parse(this.linkMetadataRaw):this.linkMetadata_={}),this.linkMetadata_}}),{on_event:function(t,e){n=!1,r[t]=e,f.allEvents=!1,f.events.push(t),f.options.definesFold=!0},on_init_state:function(t){l=t,f.options.definesFold=!0},on_init_shared_state:function(t){d=t,f.options.definesFold=!0},on_any:function(t){n=!1,f.allEvents=!0,o.push(t),f.options.definesFold=!0},on_raw:function(t){n=!1,f.allEvents=!0,s.push(t),f.options.definesFold=!0},on_deleted_notification:function(t){a.push(t),f.options.handlesDeletedNotifications=!0,f.options.definesFold=!0},on_created_notification:function(t){i.push(t),f.options.handlesCreatedNotifications=!0,f.options.definesFold=!0},fromAll:function(){f.allStreams=!0},fromCategory:function(t){f.categories.push(t)},fromStream:function(t){f.streams.push(t)},byStream:function(){f.byStreams=!0},partitionBy:function(t){c=t,f.byCustomPartitions=!0},$defines_state_transform:function(){f.options.definesStateTransform=!0,f.options.producesResults=!0},$outputState:function(){f.options.producesResults=!0},chainTransformBy:function(t){u.push(t),f.options.definesStateTransform=!0,f.options.producesResults=!0},emit:function(t){e("emit",JSON.stringify(t))},options:function(t){for(var e in t){if(void 0===f.options[e])throw"Unrecognized option: "+e;f.options[e]=t[e]}},register_command_handlers:function(t){for(var e in y)t(e,y[e])}}}};function _(t){console.log("PROJECTIONS (JS): ",t)}var S=(t,e)=>{function n(){h.$defines_state_transform()}function r(t){return h.chainTransformBy(t),{transformBy:r,filterBy:o,outputState:i,outputTo:a}}function o(t){return h.chainTransformBy((function(e){return t(e)?e:null})),{transformBy:r,filterBy:o,outputState:i,outputTo:a}}function a(t,e){h.$defines_state_transform(),h.options({resultStreamName:t,partitionResultStreamNamePattern:e})}function i(){return h.$outputState(),{transformBy:r,filterBy:o,outputTo:a}}function s(t){return function(t){for(var e in t)0==e||"$init"===e?h.on_init_state(t[e]):"$initShared"===e?h.on_init_shared_state(t[e]):"$any"===e?h.on_any(t[e]):"$deleted"===e?h.on_deleted_notification(t[e]):"$created"===e?h.on_created_notification(t[e]):h.on_event(e,t[e])}(t),{$defines_state_transform:n,transformBy:r,filterBy:o,outputTo:a,outputState:i}}function u(){return h.byStream(),{when:s}}function c(t){return h.partitionBy(t),{when:s}}function f(t){for(var e=Array.isArray(t)?t:arguments,n=0;n<e.length;n++)h.fromStream(e[n]);return{partitionBy:c,when:s,outputState:i}}return(h=v.createEventProcessor(_,e)).register_command_handlers(t),{log:function(t){"string"==typeof t?_log(t):_log(JSON.stringify(t))},on_any:h.on_any,on_raw:h.on_raw,fromAll:function(){return h.fromAll(),{partitionBy:c,when:s,foreachStream:u,outputState:i}},fromCategory:function(t){return h.fromCategory(t),{partitionBy:c,foreachStream:u,when:s,outputState:i}},fromStream:function(t){return h.fromStream(t),{partitionBy:c,when:s,outputState:i}},fromStreams:f,fromCategories:function(t){var e=Array.isArray(t)?t:Array.prototype.slice.call(arguments);return f(e=e.map((function(t){return"$ce-"+t})))},options:function(t){h.options(t)},emit:function(t,e,n,r){var o={streamId:t,eventName:e,body:JSON.stringify(n),metadata:r,isJson:!0};h.emit(o)},linkTo:function(t,e,n){var r={streamId:t,eventName:"$>",body:e.sequenceNumber+"@"+e.streamId,metadata:n,isJson:!1};h.emit(r)},copyTo:function(t,e,n){var r={},o=e.metadata;if(o)for(var a in o)0===a.indexOf("$")&&"$correlationId"!==a||(r[a]=o[a]);if(n)for(var i in n)0!==i.indexOf("$")&&(r[i]=n[i]);var s={streamId:t,eventName:e.eventType,body:e.bodyRaw,metadata:r};h.emit(s)},linkStreamTo:function(t,e,n){var r={streamId:t,eventName:"$@",body:e,metadata:n,isJson:!1};h.emit(r)}}};const b={};let w,O,N;const J=eval,k=(t,e)=>{b[t]=e},P=(t,e)=>{"emit"===t?(O(e),console.log("NOTIFY",e)):console.error("unsupported notify type",t)},E=t=>{N&&N(t)};c({onEmit:t=>{O=t},onStateChange:t=>{N=t},setCode:async t=>{((t,e)=>{self._scope=e,J(`with (_scope) { ${t} }`),delete self._scope})(t,S(k,P)),w=JSON.parse(b.get_sources()),b.initialize(),E(b.debugging_get_state())},resetState:()=>{b.initialize(),E(b.debugging_get_state())},processEvent:t=>{if(t.category=t.streamId.substring(0,t.streamId.indexOf("-")),!function(t){return!(!w.allStreams&&!w.streams.includes(t.streamId)||!w.allEvents&&!w.events.includes(t.eventType))||!!w.categories.includes(t.category)}(t))return;w.byCustomPartitions&&(t.partition=b.get_state_partition(t.body,t.isJson,t.streamId,t.eventType,t.category,t.sequenceNumber,t.metadata,t.linkMetadata)),b.process_event(t.body,t.isJson,t.streamId,t.eventType,t.category,t.sequenceNumber,t.metadata,t.linkMetadata,t.partition);const e=b.transform_state_to_result();E(e)}})}]);